options:
  machineType: "E2_HIGHCPU_32"
# options:
#   pool:
#     name: 'projects/$PROJECT_ID/locations/europe-west1/workerPools/large-pool'
timeout: 16600s
steps:
- name: rust:bullseye
  script: |
    apt-get update \
    && apt-get install -y cmake protobuf-compiler && \
    RUSTFLAGS="-g" cargo build --release --bins --package graph-node
- name: 'docker'
  id: 'graph-node'
  args: ['build',
        '--ulimit', 'nofile=1024000:1024000',
        '--build-arg', 'COMMIT_SHA=$COMMIT_SHA',
        '--build-arg', 'REPO_NAME=$REPO_NAME',
        '--build-arg', 'BRANCH_NAME=$BRANCH_NAME',
        '--build-arg', 'TAG_NAME=$TAG_NAME',
        '-t', 'europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:$SHORT_SHA',
        '-t', 'europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:dev',
        '-f', 'docker/Dockerfile-external', '.']
- name: 'docker'
  args: ['push', 'europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:$SHORT_SHA']
- name: 'docker'
  args: ['push', 'europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:dev']
images: ['europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:$SHORT_SHA',
  'europe-docker.pkg.dev/$PROJECT_ID/docker-graph-node/graph-node:dev']