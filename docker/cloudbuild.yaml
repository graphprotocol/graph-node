options:
  machineType: "E2_HIGHCPU_32"
timeout: 1800s
steps:
- name: 'docker'
  args: ['buildx', 'create', '--driver', 'docker-container', '--name', 'container', '--use']
- name: 'gcr.io/cloud-builders/docker'
  args: ['buildx', 'build', '--platform', 'linux/amd64,linux/arm64',
         '--target', 'graph-node-build',
         '--build-arg', 'COMMIT_SHA=$COMMIT_SHA',
         '--build-arg', 'REPO_NAME=$REPO_NAME',
         '--build-arg', 'BRANCH_NAME=$BRANCH_NAME',
         '--build-arg', 'TAG_NAME=$TAG_NAME',
         '-t', 'gcr.io/$PROJECT_ID/graph-node-build:$SHORT_SHA',
         '--push',
         '-f', 'docker/Dockerfile', '.']
- name: 'gcr.io/cloud-builders/docker'
  args: ['buildx', 'build', '--platform', 'linux/amd64,linux/arm64',
         '--target', 'graph-node',
         '--build-arg', 'COMMIT_SHA=$COMMIT_SHA',
         '--build-arg', 'REPO_NAME=$REPO_NAME',
         '--build-arg', 'BRANCH_NAME=$BRANCH_NAME',
         '--build-arg', 'TAG_NAME=$TAG_NAME',
         '-t', 'gcr.io/$PROJECT_ID/graph-node:$SHORT_SHA',
         '--push',
         '-f', 'docker/Dockerfile', '.']
- name: 'gcr.io/cloud-builders/docker'
  args: ['buildx', 'build', '--platform', 'linux/amd64,linux/arm64',
         '--target', 'graph-node-debug',
         '--build-arg', 'COMMIT_SHA=$COMMIT_SHA',
         '--build-arg', 'REPO_NAME=$REPO_NAME',
         '--build-arg', 'BRANCH_NAME=$BRANCH_NAME',
         '--build-arg', 'TAG_NAME=$TAG_NAME',
         '-t', 'gcr.io/$PROJECT_ID/graph-node-debug:$SHORT_SHA',
         '--push',
         '-f', 'docker/Dockerfile', '.']
